<!DOCTYPE html>
<html lang="pt-br">

<head>
    <title>Dashboard - Melodias Sem Fronteiras</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="imagex/png" href="../assets/icon.png">
    <link rel="stylesheet" href="../css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/dashboard.js"></script>
    <script src="../js/slides.js"></script>
    <script src="../js/sessao.js"></script>
</head>

<body onload="bemVindoNovamente(), obter()">
    <header>
        <div class="left_header">
            <a href="dashboard.html" class="a_logo_header"><img class="logo" src="../assets/logo-branca.png"></a>
            <ul class="navbar">
                <li><a href="dashboard.html">home</a></li>
                <li><a href="aulas/aulas.html">aulas</a></li>
                <li><a href="videos/videos.html">videos</a></li>
                <li><a href="jogos/jogos.html">jogos</a></li>
                <li><a href="eventos/eventos.html">eventos</a></li>
                <li><a href="novidades/novidades.html">novidades</a></li>
            </ul>
        </div>
        <div class="right_header">
            <div class="profile-container">
                <a class="foto_perfil">
                    <img class="foto_perfil" src="../assets/fotoPerfil/1.jpg">
                </a>
                <div id="menuModal" class="menuModal">
                    <ul class="menu_perfil">
                        <li><a href="conta.html"><img class="icon_menu" src="../assets/perfil.png">Conta</a>
                        </li>
                        <li><a href="eventos/meusIngressos.html"><img class="icon_menu" src="../assets/bilhete.png">Meus
                                ingressos</a>
                        </li>
                        <li><a href="../login_cadastro/login.html"><img class="icon_menu" src="../assets/sair.png">Sair
                                da conta</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div id="carrosel" class="carrosel">
            <div id="container" class="container">
                <div class="itens_carrosel">
                    <div class="banner">
                        <img src="../assets/bannerEvento.png" onclick="consertoViolino()" alt="Evento">
                    </div>
                </div>
                <div class="itens_carrosel">
                    <div class="banner">
                        <img src="../assets/bannerNovidades.png" onclick="novidades()" alt="Novidades">
                    </div>
                </div>
                <div class="itens_carrosel">
                    <div class="banner">
                        <img src="../assets/bannerJogo2.png" onclick="jogoMemoria()" alt="Jogo">
                    </div>
                </div>
            </div>
        </div>
        <div id="home" class="secao home">
            <div id="parte1">
                <div id="bemVindo" class="bemVindo"></div>
                <div id="graficos" class="graficos">
                    <canvas id="coluna_canva"></canvas>
                </div>
            </div>
        </div>
        <div id="aulas secao">
            <h2>Aulas</h2>
            <div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
        <div id="videos secao">
            <h2>Videos mais curtidos</h2>
            <div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
        <div id="jogos secao">
            <h2>Jogos educacionais</h2>
            <div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
        <div id="eventos secao">
            <h2>Eventos</h2>
            <div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
        <div id="audicoes secao">
            <h2>Audições</h2>
            <div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
        <div id="novidades secao">
            <h2>Novidades</h2>
            <div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
    </main>
</body>

</html>
<script>
    let b_usuario = sessionStorage.NOME_USUARIO;

    const coluna = document.getElementById('coluna_canva');

    function bemVindoNovamente() {
        bemVindo.innerHTML = `<h2>Bem-vindo(a), ${b_usuario} novamente!</h2><br>
        <div style="display: flex; align-item: center; gap:5px; margin-bottom:7px;"><img style="width: 25px;" src="../assets/trofeu.png"><h3>Ranking em tempo real:</h3></div>`
    }

    function plotarGrafico(resposta) {
        console.log(resposta)

        let labels = [];

        let dados = {
            labels: labels,
            datasets: [{
                label: 'Top 5 maiores pontuadores',
                data: [],
                backgroundColor: 'rgb(254, 92, 0)',
                borderColor: 'rgb(197, 74, 3)',
                borderWidth: 1,
                fill: true,
            }]
        };


        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (let i = 0; i < resposta.length; i++) {
            let registro = resposta[i];
            labels.push(registro.nome); // Adiciona o nome do usuário como rótulo
            dados.datasets[0].data.push(registro.totalPontuacao);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
        };

        let myChart = new Chart(
            document.getElementById(`coluna_canva`),
            config
        );

        setTimeout(() => atualizarGrafico(dados, myChart), 2000);
    }

    function obter() {
        fetch("/ranking/obter", { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    plotarGrafico(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function atualizarGrafico(dados, myChart) {
        fetch("/ranking/obter", { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    if (novoRegistro.length > 0 && novoRegistro[0].totalPontuacao !== dados.labels[dados.labels.length - 1]) {
                        if (!dados.labels.includes(novoRegistro[0].nome)) {
                            if (dados.labels.length >= 5) {
                                dados.labels.pop();
                                dados.datasets[0].data.pop();
                            }
                            dados.labels.unshift(novoRegistro[0].nome);
                            dados.datasets[0].data.unshift(novoRegistro[0].totalPontuacao);
                            myChart.update();
                        } else {
                            console.log("Novo dado duplicado. O gráfico não será atualizado.");
                        }
                    } else {
                        console.log("Nenhum novo dado disponível. O gráfico não será atualizado.");
                    }
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado');
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 2000);
            });
    }

    function novidades() {
        window.location.href = 'novidades/novidades.html'
    }

    function consertoViolino() {
        window.location.href = 'eventos/eventos/astrosSemFronteiras.html'
    }

    function jogoMemoria() {
        window.location.href = 'jogos/jogos/jogoMemoria.html'
    }
</script>