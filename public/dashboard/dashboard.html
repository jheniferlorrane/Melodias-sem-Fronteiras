<!DOCTYPE html>
<html lang="pt-br">

<head>
    <title>Dashboard - Melodias Sem Fronteiras</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="imagex/png" href="../assets/icon.png">
    <link rel="stylesheet" href="../css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/dashboard.js"></script>
    <script src="../js/sessao.js"></script>
</head>

<body onload="bemVindoNovamente(), obter()">
    <header>
        <div class="left_header">
            <a href="dashboard.html" class="a_logo_header"><img class="logo" src="../assets/logo-branca.png"></a>
            <ul class="navbar">
                <li><a href="dashboard.html">home</a></li>
                <li><a href="aulas/aulas.html">aulas</a></li>
                <li><a href="videos/videos.html">videos</a></li>
                <li><a href="jogos/jogos.html">jogos</a></li>
                <li><a href="eventos/eventos.html">eventos</a></li>
                <li><a href="novidades/novidades.html">novidades</a></li>
            </ul>
        </div>
        <div class="right_header">
            <div class="profile-container">
                <a class="foto_perfil">
                    <img class="foto_perfil" src="../assets/fotoPerfil/1.jpg">
                </a>
                <div id="menuModal" class="menuModal">
                    <ul class="menu_perfil">
                        <li><a href="eventos/meusIngressos.html"><img class="icon_menu" src="../assets/bilhete.png">Meus
                                ingressos</a>
                        </li>
                        <li><a href="../login_cadastro/login.html"><img class="icon_menu" src="../assets/sair.png">Sair
                                da conta</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div id="carrosel" class="carrosel">
            <div id="container" class="container">
                <div class="itens_carrosel">
                    <div class="banner">
                        <img src="../assets/bannerEvento.png" onclick="consertoViolino()" alt="Evento">
                    </div>
                </div>
                <div class="itens_carrosel">
                    <div class="banner">
                        <img src="../assets/bannerNovidades.png" onclick="novidades()" alt="Novidades">
                    </div>
                </div>
                <div class="itens_carrosel">
                    <div class="banner">
                        <img src="../assets/bannerJogo2.png" onclick="jogoNotas()" alt="Jogo">
                    </div>
                </div>
            </div>
        </div>
        <div id="home" class="secao home">
            <div id="parte1">
                <div id="bemVindo" class="bemVindo"></div>
                <div class="comeco">
                    <div class="comeco_1">
                        <div style="display: flex; align-item: center; gap:5px; margin-bottom:7px;"><img
                                style="width: 25px;" src="../assets/trofeu.png">
                            <h3>Veja abaixo o ranking dos maiores pontuadores</h3>
                        </div>
                        <div id="graficos" class="graficos">
                            <canvas id="coluna_canva"></canvas>
                        </div>
                    </div>
                    <div class="comeco_1">
                        <div
                            style="display: flex; flex-direction: column; align-item: center; gap:5px; margin-bottom:7px;">
                            <h3>Bora aumentar sua pontuação? Jogue agora!</h3>
                            <img style="width: 90%; padding-top: 2%;" src="../assets/bannerJogo2.png"
                                onclick="jogoNotas()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="secao conteudoHome">
            <div id="aulas">
                <div class="redirecionador" onclick="aulas()">
                    <h3>Aulas <span class="boldTitulo">></span></h3>
                </div>
                <div class="paiSecoes">
                    <div class="secoes"><img src="../assets/bannerAulas_VIdeos/teclado.jpg"></div>
                    <div class="secoes"><img src="../assets/bannerAulas_VIdeos/canto.jpg"></div>
                    <div class="secoes"><img src="../assets/bannerAulas_VIdeos/violãoBasico.jpg"></div>
                </div>
                <div id="modal_div" class="modal_div" style="display: none;">
                    <div id="conteudo_modal">
                        <div class="header_modal">
                            <button class="btn" id="fechar_modal" onclick="fecharModal()">Fechar</button>
                        </div>
                        <div class="resultado">
                            <div id="exibir_resultado"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="videos">
                <div class="redirecionador" onclick="videos()">
                    <h3>Videos mais curtidos <span class="boldTitulo">></span></h3>
                </div>
                <div class="paiSecoes">
                    <div class="secoes"></div>
                    <div class="secoes"></div>
                    <div class="secoes"></div>
                </div>
            </div>
            <div id="jogos">
                <div class="redirecionador" onclick="jogos()">
                    <h3>Jogos educacionais <span class="boldTitulo">></span></h3>
                </div>
                <div class="paiSecoes">
                    <div class="secoes" onclick="jogoNotas()"><img src="../assets/bannerJogo2.png"></div>
                    <div class="secoes" onclick="jogoMemoria()"><img src="../assets/bannerJogo2.png"></div>
                </div>
            </div>
            <div id="eventos">
                <div class="redirecionador" onclick="eventos()">
                    <h3>Eventos da Semana <span class="boldTitulo">></span></h3>
                </div>
                <div class="paiSecoes">
                    <div class="secoes" onclick="consertoViolino()"><img src="../assets/bannerEvento.png"></div>
                </div>
            </div>
            <div id="novidades">
                <div class="redirecionador" onclick="novidades()">
                    <h3>Novidades <span class="boldTitulo">></span></h3>
                </div>
                <div class="paiSecoes">   
                    <div class="secoes" onclick="holograma()"><img src="../assets/holografico.jpg"></div>            
                    <div class="secoes" onclick="consertoViolino()"><img src="../assets/bannerEvento.png"></div>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <div class="rodape_conteudo">
            <img class="logo_rodape" src="../assets/logo-branca.png">
            <div class="colunas">
                <div class="coluna1">
                    <span>
                        <h3>Menus</h3>
                        <br>
                        <a href="aulas/aulas.html" class="button_rodape">Aulas</a>
                        <br>
                        <a href="videos/videos.html" class="button_rodape">Videos</a>
                        <br>
                        <a href="jogos/jogos.html" class="button_rodape">Jogos</a>
                        <br>
                        <a href="eventos/eventos.html" class="button_rodape">Eventos</a>
                        <br>
                        <a href="novidades/novidades.html" class="button_rodape">Novidades</a>
                        <br>
                    </span>
                </div>

                <div class="coluna2">
                    <span>
                        <h3>Conta</h3>
                        <br>
                        <a href="eventos/meusIngressos.html" class="button_rodape">Meus ingressos</a>
                        <br>
                        <a href="../login_cadastro/login.html" class="button_rodape">Sair da Conta</a>
                        <br>
                    </span>
                </div>

                <div class="coluna3">
                    <span>
                        <h3>Suporte</h3>
                        <br>
                        <a href="contato.html" class="button_rodape">Contato</a>
                    </span>
                </div>
            </div>
        </div>
    </footer>
</body>

</html>
<script>
    let b_usuario = sessionStorage.NOME_USUARIO;

    const coluna = document.getElementById('coluna_canva');

    function bemVindoNovamente() {
        bemVindo.innerHTML = `<h2 style="line-height: 38px;">Bem-vindo(a) ${b_usuario},<br> É sempre um prazer ter um amante da música aqui!</h2><br><br><br>`
    }

    function plotarGrafico(resposta) {
        console.log(resposta)

        let labels = [];

        let dados = {
            labels: labels,
            datasets: [{
                label: 'Top 5 maiores pontuadores',
                data: [],
                backgroundColor: 'rgb(254, 92, 0)',
                borderColor: 'rgb(197, 74, 3)',
                borderWidth: 1,
                fill: true,
            }]
        };


        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (let i = 0; i < resposta.length; i++) {
            let registro = resposta[i];
            labels.push(registro.nome); // Adiciona o nome do usuário como rótulo
            dados.datasets[0].data.push(registro.totalPontuacao);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
        };

        let myChart = new Chart(
            document.getElementById(`coluna_canva`),
            config
        );

        setTimeout(() => atualizarGrafico(dados, myChart), 2000);
    }

    function obter() {
        fetch("/ranking/obter", { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    plotarGrafico(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function atualizarGrafico(dados, myChart) {
        fetch("/ranking/obter", { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    if (novoRegistro.length > 0 && novoRegistro[0].totalPontuacao !== dados.labels[dados.labels.length - 1]) {
                        if (!dados.labels.includes(novoRegistro[0].nome)) {
                            if (dados.labels.length >= 5) {
                                dados.labels.pop();
                                dados.datasets[0].data.pop();
                            }
                            dados.labels.unshift(novoRegistro[0].nome);
                            dados.datasets[0].data.unshift(novoRegistro[0].totalPontuacao);
                            myChart.update();
                        } else {
                            console.log("Novo dado duplicado. O gráfico não será atualizado.");
                        }
                    } else {
                        console.log("Nenhum novo dado disponível. O gráfico não será atualizado.");
                    }
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado');
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 2000);
            });
    }

    function novidades() {
        window.location.href = 'novidades/novidades.html'
    }

    function consertoViolino() {
        window.location.href = 'eventos/eventos/astrosSemFronteiras.html'
    }

    function jogoMemoria() {
        window.location.href = 'jogos/jogos/jogoMemoria.html'
    }

    function jogoNotas() {
        window.location.href = 'jogos/jogos/jogoNotas.html'
    }

    function eventos() {
        window.location.href = 'eventos/eventos.html'
    }

    function aulas() {
        window.location.href = 'aulas/aulas.html'
    }

    function videos() {
        window.location.href = 'videos/videos.html'
    }
    
    function holograma() {
        window.location.href = 'novidades/noticia.html'
    }

    function jogos() {
        window.location.href = 'jogos/jogos.html'
    }
</script>